#!/usr/bin/env bash
# Asks for sudo and keeps it alive until dot script is finished
# Options:
#   -r    Specify the reason why sudo is needed
#   -s    For step-user style pprint

source $DOT/.dot/functions/keepsudo
source $DOT/.dot/functions/try

while getopts “sr:t:” OPTION; do
  case $OPTION in
    r)
      reason="${OPTARG}";;
    s)
      pprint_step=true;;
  esac
done

pprint_type='info-warn'
[[ "${pprint_step}" ]] && pprint_type='step-user'
[[ $MAKEPID ]] && pid="-a $MAKEPID"

if [[ $(sudo -n true 2>&1) ]]; then
  pprint "${pprint_type}" -n "Can I haz sudo? ${reason}"
  try keepsudo -p "$(pprint text -r '.. Password: ')" ${pid}
  [[ $TRY_CODE == 0 ]] && pprint text -r ".. \033[0;32mkthxbye\033[0m"
  [[ $TRY_CODE != 0 ]] && pprint text -r ".. \033[0;31mnope\033[0m"
  [[ $TRY_CODE != 0 ]] || [[ ${pprint_step} ]] && pprint newline
fi

exit $TRY_CODE
